{% extends "base.html" %}
{% block content %}

<div class="bill-wrapper">

    <div class="bill-card">

        <!-- HEADER -->
        <div class="bill-header">
            <h2>ðŸ§¾ SmartBite CafÃ© - Bill</h2>
            <p>Table No: <strong>{{ table_no }}</strong></p>
        </div>

        {% if orders|length == 0 %}

        <!-- EMPTY STATE -->
        <div class="empty-bill">
            <h3>No Bill Generated Yet</h3>
            <p>Order something from menu to generate bill.</p>
            <a href="/menu?table={{ table_no }}" class="start-btn">
                Start Ordering
            </a>
        </div>

        {% elif not bill_generated %}

        <!-- GENERATE BILL SECTION -->
        <div class="generate-section">
            <h3>Total Amount</h3>
            <h2>â‚¹{{ grand_total }}</h2>

            <form action="{{ url_for('generate_bill', table_no=table_no) }}" method="POST">
                <button type="submit" class="generate-btn">
                    Generate Bill
                </button>
            </form>
        </div>

        {% else %}

        <!-- BILL TABLE -->
        <table class="bill-table">
            <tr>
                <th>Item</th>
                <th>Qty</th>
                <th>Price</th>
                <th>Total</th>
            </tr>

            {% for order in orders %}
            <tr>
                <td>{{ order['item_name'] }}</td>
                <td>{{ order['quantity'] }}</td>
                <td>â‚¹{{ order['price'] }}</td>
                <td>â‚¹{{ order['quantity'] * order['price'] }}</td>
            </tr>
            {% endfor %}
        </table>

        <!-- SUMMARY -->
        <div class="bill-summary">
            <p>Subtotal: â‚¹{{ subtotal }}</p>
            <p>GST (5%): â‚¹{{ gst }}</p>
            <p>Service Charge (5%): â‚¹{{ service_charge }}</p>
            <h4>Grand Total: â‚¹{{ grand_total }}</h4>

            <!-- Split Option -->
            <div class="split-box">
                <label>Split Bill:</label>
                <input type="number" id="splitCount" min="1" placeholder="People">
                <button onclick="splitBill()">Calculate</button>
                <span id="splitResult"></span>
            </div>
        </div>

        <!-- BUTTONS -->
        <button class="pay-btn" onclick="openPaymentModal()">
            ðŸ’³ Pay Now
        </button>

        {% if payment_done %}
<a href="/download_bill_pdf/{{ table_no }}" class="pdf-btn">
    Download PDF
</a>
{% else %}
<button class="pdf-btn disabled-btn" disabled>
    ðŸ”’ Pay to Download PDF
</button>
{% endif %}

        {% endif %}

    </div>
</div>

<!-- PAYMENT MODAL -->
<div id="paymentModal" class="payment-modal">
    <div class="payment-box">
        <h3>Select Payment Method</h3>

        <label>
            <input type="radio" name="paymode" value="UPI" onchange="showSection('upi')"> UPI
        </label>

        <label>
            <input type="radio" name="paymode" value="Card" onchange="showSection('card')"> Card
        </label>

        <label>
            <input type="radio" name="paymode" value="Cash" onchange="showSection('cash')"> Cash
        </label>

        <!-- UPI SECTION -->
        <div id="upiSection" class="pay-section">
            <p>Scan QR to Pay</p>
            <img src="/static/images/qrcode.jpg" width="180">
            <p><b>UPI ID:</b> smartbite@upi</p>
            <button onclick="startProcessing('UPI')">I Have Paid</button>
        </div>

        <!-- CARD SECTION -->
        <div id="cardSection" class="pay-section">
            <input type="text" placeholder="Card Number">
            <input type="text" placeholder="MM/YY">
            <input type="text" placeholder="CVV">
            <button onclick="startProcessing('Card')">Pay Now</button>
        </div>

        <!-- CASH SECTION -->
        <div id="cashSection" class="pay-section">
            <p>Please pay at counter.</p>
            <button onclick="startProcessing('Cash')">Confirm Cash Payment</button>
        </div>

        <!-- LOADER -->
        <div id="paymentLoader" style="display:none;">
            <p>Processing Payment...</p>
            <div class="spinner"></div>
        </div>
    </div>
</div>

<script>

function openPaymentModal(){
    document.getElementById("paymentModal").style.display = "flex";
}

function showSection(type){
    document.getElementById("upiSection").style.display = "none";
    document.getElementById("cardSection").style.display = "none";
    document.getElementById("cashSection").style.display = "none";

    if(type === "upi"){
        document.getElementById("upiSection").style.display = "block";
    }
    if(type === "card"){
        document.getElementById("cardSection").style.display = "block";
    }
    if(type === "cash"){
        document.getElementById("cashSection").style.display = "block";
    }
}

function splitBill(){
    let people = document.getElementById("splitCount").value;
    let total = Number("{{ grand_total }}");

    if(people > 0){
        let perPerson = (total / people).toFixed(2);
        document.getElementById("splitResult").innerHTML =
            "Each Pays: â‚¹" + perPerson;
    }
}

function startProcessing(mode){

    document.getElementById("upiSection").style.display = "none";
    document.getElementById("cardSection").style.display = "none";
    document.getElementById("cashSection").style.display = "none";
    document.getElementById("paymentLoader").style.display = "block";

    setTimeout(function(){

        // 10% chance failure simulation
        let success = Math.random() > 0.1;

        if(!success){
            Swal.fire({
                icon: "error",
                title: "Payment Failed",
                text: "Transaction declined. Please try again."
            });
            document.getElementById("paymentLoader").style.display = "none";
            return;
        }

        fetch("/api/pay/{{ table_no }}", {
            method:"POST",
            headers:{
                "Content-Type":"application/json"
            },
            body: JSON.stringify({
                mode: mode
            })
        })
        .then(response => response.json())
        .then(data => {

    Swal.fire({
        icon: 'success',
        title: 'Payment Successful!',
        text: 'Transaction ID: ' + data.transaction_id,
        confirmButtonText: 'Download Bill'
    }).then(() => {

        // Create hidden link to download PDF
        const link = document.createElement("a");
        link.href = "/download_bill_pdf/{{ table_no }}";
        link.download = "Bill_Table_{{ table_no }}.pdf";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        // After download starts, reload bill page
        setTimeout(() => {
            window.location.href = "/bill/{{ table_no }}";
        }, 1000);

    });

})
    }, 3000); // 3 second realistic delay
}

</script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

{% endblock %}