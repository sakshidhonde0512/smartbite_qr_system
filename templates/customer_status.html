{% extends "base.html" %}

{% block content %}

<div class="status-header">
    <h2>ðŸ§¾ Your Orders</h2>
    <span>Table {{ table_no }} Â· Live Status</span>
</div>

<div class="orders-container" id="orders"></div>

<div class="status-footer">
    Updates automatically Â· Please wait while your order is prepared â˜•
</div>

<script>
const tableNo = "{{ table_no }}";

function getProgress(status) {
    switch (status.toLowerCase()) {
        case "ordered": return 25;
        case "preparing": return 55;
        case "ready": return 85;
        case "served": return 100;
        default: return 0;
    }
}

function loadOrders() {
    fetch(`/api/customer_status?table=${tableNo}`)
        .then(res => res.json())
        .then(data => {
            let html = "";
            let subtotal = 0;

            if (data.length === 0) {
                html = `
                    <div class="order-card">
                        <h3>No active orders</h3>
                        <div class="order-info">Please place an order to see live status.</div>
                    </div>
                `;
            }

            data.forEach(order => {

    // ðŸš« Skip cancelled orders completely
    if (order.status.toLowerCase() === "cancelled") {
        return;
    }

    const progress = getProgress(order.status);

    subtotal += order.quantity * order.price;

    let actionButtons = "";

    // âœ… Show buttons only if status is Ordered
    if (order.status.toLowerCase() === "ordered") {
        actionButtons = `
    <div class="order-actions">
        <div class="qty-controls">
            <button onclick="changeQty(${order.id}, 1)">+</button>
            <button onclick="changeQty(${order.id}, -1)">âˆ’</button>
        </div>
        <button class="cancel-btn" onclick="cancelOrder(${order.id})">Cancel</button>
    </div>
`;
    }

    html += `
        <div class="order-card">
            <h3>${order.item_name}</h3>
            <div class="order-info">
                Quantity: ${order.quantity}<br>
                <span class="price">â‚¹${order.price}</span>
            </div>
            <span class="status ${order.status.toLowerCase()}">
                ${order.status}
            </span>
            <div class="progress">
                <div class="progress-bar" style="width:${progress}%"></div>
            </div>
            ${actionButtons}
        </div>
    `;
});
            if (data.length > 0) {
                const gst = (subtotal * 0.05).toFixed(2);
                const grandTotal = (subtotal + parseFloat(gst)).toFixed(2);

                html += `
                    <div class="order-card total-card">
                        <h3>Bill Summary</h3>
                        <div class="order-info">
                            Subtotal: â‚¹${subtotal.toFixed(2)}<br>
                            GST (5%): â‚¹${gst}<br>
                            <strong>Grand Total: â‚¹${grandTotal}</strong>
                        </div>
                    </div>
                `;
            }

            document.getElementById("orders").innerHTML = html;
        });
}

function cancelOrder(orderId) {
    fetch(`/cancel-order/${orderId}`, {
        method: "POST"
    }).then(() => loadOrders());
}

function changeQty(orderId, change) {
    fetch(`/update-order/${orderId}`, {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
            quantity: change
        })
    }).then(() => loadOrders());
}

loadOrders();
setInterval(loadOrders, 3000);
</script>

{% endblock %}